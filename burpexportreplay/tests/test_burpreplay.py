import pytest
from burpexportreplay import burpreplay

def testUpdateRequestHost():
    request = b'POST /downloads?client=navclient-auto-ffox&appver=78.0&pver=2.2 HTTP/1.1\r\nHost: shavar.services.mozilla.com\r\nCookie: ASP.NET_SessionId=A-Cookie; .ASPXAUTH=Another-Cookie\r\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0\r\nAccept: */*\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nContent-Type: text/plain\r\nContent-Length: 773\r\nConnection: close\r\nPragma: no-cache\r\nCache-Control: no-cache\r\n\r\nsocial-tracking-protection-linkedin-digest256;a:1591202430\nexcept-flashallow-digest256;a:1490633678\nexcept-flashsubdoc-digest256;a:1517935265\nblock-flash-digest256;a:1496263270\ncontent-track-digest256;a:1594235398\nads-track-digest256;a:1591202430\nsocial-tracking-protection-facebook-digest256;a:1591202430\nanalytics-track-digest256;a:1591202430\nblock-flashsubdoc-digest256;a:1512160865\nsocial-track-digest256;a:1594235398\nbase-cryptomining-track-digest256;a:1591202430\nexcept-flash-digest256;a:1494877265\nallow-flashallow-digest256;a:1490633678\nmozstd-trackwhite-digest256;a:1591202430\nmozplugin-block-digest256;a:1471849627\nbase-fingerprinting-track-digest256;a:1591202430\nsocial-tracking-protection-twitter-digest256;a:1591202430\ngoogle-trackwhite-digest256;a:1591202430\n'
    request = burpreplay.updateRequestHost(request, b'FAKEHOST', 80)
    assert b'Host: FAKEHOST:80\r\n' in request

def testUpdateRequestHeader():
    request = b'POST /downloads?client=navclient-auto-ffox&appver=78.0&pver=2.2 HTTP/1.1\r\nHost: shavar.services.mozilla.com\r\nCustom-Header: Somevalue\r\nCookie: ASP.NET_SessionId=A-Cookie; .ASPXAUTH=Another-Cookie\r\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0\r\nAccept: */*\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nContent-Type: text/plain\r\nContent-Length: 773\r\nConnection: close\r\nPragma: no-cache\r\nCache-Control: no-cache\r\n\r\nsocial-tracking-protection-linkedin-digest256;a:1591202430\nexcept-flashallow-digest256;a:1490633678\nexcept-flashsubdoc-digest256;a:1517935265\nblock-flash-digest256;a:1496263270\ncontent-track-digest256;a:1594235398\nads-track-digest256;a:1591202430\nsocial-tracking-protection-facebook-digest256;a:1591202430\nanalytics-track-digest256;a:1591202430\nblock-flashsubdoc-digest256;a:1512160865\nsocial-track-digest256;a:1594235398\nbase-cryptomining-track-digest256;a:1591202430\nexcept-flash-digest256;a:1494877265\nallow-flashallow-digest256;a:1490633678\nmozstd-trackwhite-digest256;a:1591202430\nmozplugin-block-digest256;a:1471849627\nbase-fingerprinting-track-digest256;a:1591202430\nsocial-tracking-protection-twitter-digest256;a:1591202430\ngoogle-trackwhite-digest256;a:1591202430\n'
    request = burpreplay.updateRequestHeader(request, b'Custom-Header', b'FAKEVALUE')
    assert b'Custom-Header: FAKEVALUE\r\n' in request

def testUpdateRequestUserAgent():
    request = b'POST /downloads?client=navclient-auto-ffox&appver=78.0&pver=2.2 HTTP/1.1\r\nHost: shavar.services.mozilla.com\r\nCustom-Header: Somevalue\r\nCookie: ASP.NET_SessionId=A-Cookie; .ASPXAUTH=Another-Cookie\r\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0\r\nAccept: */*\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nContent-Type: text/plain\r\nContent-Length: 773\r\nConnection: close\r\nPragma: no-cache\r\nCache-Control: no-cache\r\n\r\nsocial-tracking-protection-linkedin-digest256;a:1591202430\nexcept-flashallow-digest256;a:1490633678\nexcept-flashsubdoc-digest256;a:1517935265\nblock-flash-digest256;a:1496263270\ncontent-track-digest256;a:1594235398\nads-track-digest256;a:1591202430\nsocial-tracking-protection-facebook-digest256;a:1591202430\nanalytics-track-digest256;a:1591202430\nblock-flashsubdoc-digest256;a:1512160865\nsocial-track-digest256;a:1594235398\nbase-cryptomining-track-digest256;a:1591202430\nexcept-flash-digest256;a:1494877265\nallow-flashallow-digest256;a:1490633678\nmozstd-trackwhite-digest256;a:1591202430\nmozplugin-block-digest256;a:1471849627\nbase-fingerprinting-track-digest256;a:1591202430\nsocial-tracking-protection-twitter-digest256;a:1591202430\ngoogle-trackwhite-digest256;a:1591202430\n'
    request = burpreplay.updateRequestUserAgent(request, b'FAKEAGENT')
    assert b'User-Agent: FAKEAGENT\r\n' in request

def testUpdateRequestAuthorization():
    request = b'POST /downloads?client=navclient-auto-ffox&appver=78.0&pver=2.2 HTTP/1.1\r\nHost: shavar.services.mozilla.com\r\nAuthorization: bearer RkFLRUFVVEg=\r\nCustom-Header: Somevalue\r\nCookie: ASP.NET_SessionId=A-Cookie; .ASPXAUTH=Another-Cookie\r\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0\r\nAccept: */*\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nContent-Type: text/plain\r\nContent-Length: 773\r\nConnection: close\r\nPragma: no-cache\r\nCache-Control: no-cache\r\n\r\nsocial-tracking-protection-linkedin-digest256;a:1591202430\nexcept-flashallow-digest256;a:1490633678\nexcept-flashsubdoc-digest256;a:1517935265\nblock-flash-digest256;a:1496263270\ncontent-track-digest256;a:1594235398\nads-track-digest256;a:1591202430\nsocial-tracking-protection-facebook-digest256;a:1591202430\nanalytics-track-digest256;a:1591202430\nblock-flashsubdoc-digest256;a:1512160865\nsocial-track-digest256;a:1594235398\nbase-cryptomining-track-digest256;a:1591202430\nexcept-flash-digest256;a:1494877265\nallow-flashallow-digest256;a:1490633678\nmozstd-trackwhite-digest256;a:1591202430\nmozplugin-block-digest256;a:1471849627\nbase-fingerprinting-track-digest256;a:1591202430\nsocial-tracking-protection-twitter-digest256;a:1591202430\ngoogle-trackwhite-digest256;a:1591202430\n'
    request = burpreplay.updateRequestAuthorization(request, b'bearer', b'FAKEAUTH')
    assert b'Authorization: bearer FAKEAUTH\r\n' in request

def testUpdateRequestXCsrfToken():
    request = b'POST /downloads?client=navclient-auto-ffox&appver=78.0&pver=2.2 HTTP/1.1\r\nHost: shavar.services.mozilla.com\r\nX-CSRF-TOKEN: sometoken\r\nAuthorization: bearer RkFLRUFVVEg=\r\nCustom-Header: Somevalue\r\nCookie: ASP.NET_SessionId=A-Cookie; .ASPXAUTH=Another-Cookie\r\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0\r\nAccept: */*\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nContent-Type: text/plain\r\nContent-Length: 773\r\nConnection: close\r\nPragma: no-cache\r\nCache-Control: no-cache\r\n\r\nsocial-tracking-protection-linkedin-digest256;a:1591202430\nexcept-flashallow-digest256;a:1490633678\nexcept-flashsubdoc-digest256;a:1517935265\nblock-flash-digest256;a:1496263270\ncontent-track-digest256;a:1594235398\nads-track-digest256;a:1591202430\nsocial-tracking-protection-facebook-digest256;a:1591202430\nanalytics-track-digest256;a:1591202430\nblock-flashsubdoc-digest256;a:1512160865\nsocial-track-digest256;a:1594235398\nbase-cryptomining-track-digest256;a:1591202430\nexcept-flash-digest256;a:1494877265\nallow-flashallow-digest256;a:1490633678\nmozstd-trackwhite-digest256;a:1591202430\nmozplugin-block-digest256;a:1471849627\nbase-fingerprinting-track-digest256;a:1591202430\nsocial-tracking-protection-twitter-digest256;a:1591202430\ngoogle-trackwhite-digest256;a:1591202430\n'
    request = burpreplay.updateRequestXCsrfToken(request, b'FAKETOKEN')
    assert b'X-CSRF-TOKEN: FAKETOKEN\r\n' in request

def testUpdateRequestCookie():
    request = b'POST /downloads?client=navclient-auto-ffox&appver=78.0&pver=2.2 HTTP/1.1\r\nHost: shavar.services.mozilla.com\r\nCookie: ASP.NET_SessionId=A-Cookie; .ASPXAUTH=Another-Cookie\r\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0\r\nAccept: */*\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nContent-Type: text/plain\r\nContent-Length: 773\r\nConnection: close\r\nPragma: no-cache\r\nCache-Control: no-cache\r\n\r\nsocial-tracking-protection-linkedin-digest256;a:1591202430\nexcept-flashallow-digest256;a:1490633678\nexcept-flashsubdoc-digest256;a:1517935265\nblock-flash-digest256;a:1496263270\ncontent-track-digest256;a:1594235398\nads-track-digest256;a:1591202430\nsocial-tracking-protection-facebook-digest256;a:1591202430\nanalytics-track-digest256;a:1591202430\nblock-flashsubdoc-digest256;a:1512160865\nsocial-track-digest256;a:1594235398\nbase-cryptomining-track-digest256;a:1591202430\nexcept-flash-digest256;a:1494877265\nallow-flashallow-digest256;a:1490633678\nmozstd-trackwhite-digest256;a:1591202430\nmozplugin-block-digest256;a:1471849627\nbase-fingerprinting-track-digest256;a:1591202430\nsocial-tracking-protection-twitter-digest256;a:1591202430\ngoogle-trackwhite-digest256;a:1591202430\n'
    request = burpreplay.updateRequestCookie(request, b'ASP.NET_SessionId', b'FAKESESSION')
    assert b"ASP.NET_SessionId=FAKESESSION" in request
    assert b".ASPXAUTH=Another-Cookie" in request

def testUpdateRequesBody():
    request = b'POST /downloads?client=navclient-auto-ffox&appver=78.0&pver=2.2 HTTP/1.1\r\nHost: shavar.services.mozilla.com\r\nCookie: ASP.NET_SessionId=A-Cookie; .ASPXAUTH=Another-Cookie\r\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:78.0) Gecko/20100101 Firefox/78.0\r\nAccept: */*\r\nAccept-Language: en-US,en;q=0.5\r\nAccept-Encoding: gzip, deflate\r\nContent-Type: text/plain\r\nContent-Length: 773\r\nConnection: close\r\nPragma: no-cache\r\nCache-Control: no-cache\r\n\r\nsocial-tracking-protection-linkedin-digest256;a:1591202430\nexcept-flashallow-digest256;a:1490633678\nexcept-flashsubdoc-digest256;a:1517935265\nblock-flash-digest256;a:1496263270\ncontent-track-digest256;a:1594235398\nads-track-digest256;a:1591202430\nsocial-tracking-protection-facebook-digest256;a:1591202430\nanalytics-track-digest256;a:1591202430\nblock-flashsubdoc-digest256;a:1512160865\nsocial-track-digest256;a:1594235398\nbase-cryptomining-track-digest256;a:1591202430\nexcept-flash-digest256;a:1494877265\nallow-flashallow-digest256;a:1490633678\nmozstd-trackwhite-digest256;a:1591202430\nmozplugin-block-digest256;a:1471849627\nbase-fingerprinting-track-digest256;a:1591202430\nsocial-tracking-protection-twitter-digest256;a:1591202430\ngoogle-trackwhite-digest256;a:1591202430\n'
    request = burpreplay.updateRequestBody(request, b'FAKEDATA')
    assert b"\x0d\x0a\x0d\x0aFAKEDATA\x0a" in request

